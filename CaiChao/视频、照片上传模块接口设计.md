### 视频、照片上传模块接口设计

##### 1. 媒体文件上传接口（支持视频和图片）

**请求示例：**

```http
POST /api/v1/media/upload
Content-Type: multipart/form-data
Authorization: Bearer {jwt_token}
X-Device-ID: {device_unique_id}

--boundary123456
Content-Disposition: form-data; name="media"; filename="family_vacation.mp4"
Content-Type: video/mp4

[视频文件二进制数据]
--boundary123456
Content-Disposition: form-data; name="metadata"
Content-Type: application/json

{
  "originalFilename": "family_vacation.mp4",
  "fileSize": 157286400,
  "duration": 900,
  "mimeType": "video/mp4",
  "mediaType": "video",
  "deviceId": "iPhone_12_Pro_A1B2C3D4E5F6",
  "deviceInfo": {
    "model": "iPhone 12 Pro",
    "osVersion": "iOS 17.2",
    "appVersion": "1.0.0"
  },
  "uploadedAt": "2025-01-24T10:30:00Z"
}
--boundary123456--
```

**图片上传请求示例：**
```http
POST /api/v1/media/upload
Content-Type: multipart/form-data
Authorization: Bearer {jwt_token}
X-Device-ID: {device_unique_id}

--boundary123456
Content-Disposition: form-data; name="media"; filename="photo_album.jpg"
Content-Type: image/jpeg

[图片文件二进制数据]
--boundary123456
Content-Disposition: form-data; name="metadata"
Content-Type: application/json

{
  "originalFilename": "photo_album.jpg",
  "fileSize": 5242880,
  "mimeType": "image/jpeg",
  "mediaType": "image",
  "imageCount": 1,
  "deviceId": "iPhone_12_Pro_A1B2C3D4E5F6",
  "deviceInfo": {
    "model": "iPhone 12 Pro",
    "osVersion": "iOS 17.2",
    "appVersion": "1.0.0"
  },
  "uploadedAt": "2025-01-24T10:30:00Z"
}
--boundary123456--
```

**批量图片上传请求示例：**
```http
POST /api/v1/media/upload/batch
Content-Type: multipart/form-data
Authorization: Bearer {jwt_token}
X-Device-ID: {device_unique_id}

--boundary123456
Content-Disposition: form-data; name="images"; filename="photo1.jpg"
Content-Type: image/jpeg

[图片1二进制数据]
--boundary123456
Content-Disposition: form-data; name="images"; filename="photo2.jpg"
Content-Type: image/jpeg

[图片2二进制数据]
--boundary123456
Content-Disposition: form-data; name="metadata"
Content-Type: application/json

{
  "mediaType": "image_batch",
  "imageCount": 2,
  "totalFileSize": 10485760,
  "deviceId": "iPhone_12_Pro_A1B2C3D4E5F6",
  "deviceInfo": {
    "model": "iPhone 12 Pro",
    "osVersion": "iOS 17.2",
    "appVersion": "1.0.0"
  },
  "uploadedAt": "2025-01-24T10:30:00Z"
}
--boundary123456--
```

**视频上传成功返回示例：**
```json
{
  "success": true,
  "data": {
    "mediaId": "550e8400-e29b-41d4-a716-446655440000",
    "mediaType": "video",
    "uploadStatus": "success",
    "processingEstimate": "2-3 minutes",
    "fileInfo": {
      "originalFilename": "family_vacation.mp4",
      "fileSize": 157286400,
      "duration": 900,
      "format": "mp4"
    },
    "deviceId": "iPhone_12_Pro_A1B2C3D4E5F6",
    "uploadedAt": "2025-01-24T10:30:15Z"
  },
  "message": "视频上传成功，正在处理中"
}
```

**图片上传成功返回示例：**
```json
{
  "success": true,
  "data": {
    "mediaId": "660f9511-f39c-52e5-b827-557766551111",
    "mediaType": "image",
    "uploadStatus": "success",
    "processingEstimate": "30-60 seconds",
    "fileInfo": {
      "originalFilename": "photo_album.jpg",
      "fileSize": 5242880,
      "format": "jpeg",
      "dimensions": {
        "width": 1920,
        "height": 1080
      }
    },
    "deviceId": "iPhone_12_Pro_A1B2C3D4E5F6",
    "uploadedAt": "2025-01-24T10:30:15Z"
  },
  "message": "图片上传成功，正在处理中"
}
```

**批量图片上传成功返回示例：**
```json
{
  "success": true,
  "data": {
    "batchId": "770f9511-f39c-52e5-b827-557766552222",
    "mediaType": "image_batch",
    "uploadStatus": "success",
    "processingEstimate": "1-2 minutes",
    "uploadedImages": [
      {
        "mediaId": "880f9511-f39c-52e5-b827-557766553333",
        "originalFilename": "photo1.jpg",
        "fileSize": 5242880,
        "format": "jpeg"
      },
      {
        "mediaId": "990f9511-f39c-52e5-b827-557766554444",
        "originalFilename": "photo2.jpg",
        "fileSize": 5242880,
        "format": "jpeg"
      }
    ],
    "totalImages": 2,
    "deviceId": "iPhone_12_Pro_A1B2C3D4E5F6",
    "uploadedAt": "2025-01-24T10:30:15Z"
  },
  "message": "批量图片上传成功，正在处理中"
}
```

**错误返回示例：**
```json
{
  "success": false,
  "error": {
    "code": "INVALID_VIDEO_DURATION",
    "message": "视频时长必须在5-30分钟之间",
    "details": {
      "actualDuration": 45,
      "minDuration": 300,
      "maxDuration": 1800,
      "unit": "seconds",
      "deviceId": "iPhone_12_Pro_A1B2C3D4E5F6"
    }
  },
  "timestamp": "2025-01-24T10:30:00Z"
}
```

**设备识别错误返回示例：**
```json
{
  "success": false,
  "error": {
    "code": "INVALID_DEVICE_ID",
    "message": "设备识别码无效或缺失",
    "details": {
      "providedDeviceId": "invalid_device_id",
      "expectedFormat": "设备型号_唯一标识符",
      "example": "iPhone_12_Pro_A1B2C3D4E5F6"
    }
  },
  "timestamp": "2025-01-24T10:30:00Z"
}
```

##### 2. 上传进度查询接口

**请求示例：**
```http
GET /api/v1/media/upload/{mediaId}/progress
Authorization: Bearer {jwt_token}
X-Device-ID: {device_unique_id}
```

**视频上传进度返回示例：**
```json
{
  "success": true,
  "data": {
    "mediaId": "550e8400-e29b-41d4-a716-446655440000",
    "mediaType": "video",
    "status": "uploading",
    "progress": {
      "percentage": 75,
      "uploadedBytes": 117964800,
      "totalBytes": 157286400,
      "speed": "2.5 MB/s",
      "estimatedTimeRemaining": "15 seconds"
    },
    "deviceId": "iPhone_12_Pro_A1B2C3D4E5F6"
  }
}
```

**图片上传进度返回示例：**
```json
{
  "success": true,
  "data": {
    "mediaId": "660f9511-f39c-52e5-b827-557766551111",
    "mediaType": "image",
    "status": "processing",
    "progress": {
      "percentage": 90,
      "currentStep": "AI分析中",
      "estimatedTimeRemaining": "10 seconds"
    },
    "deviceId": "iPhone_12_Pro_A1B2C3D4E5F6"
  }
}
```

**批量图片上传进度返回示例：**
```json
{
  "success": true,
  "data": {
    "batchId": "770f9511-f39c-52e5-b827-557766552222",
    "mediaType": "image_batch",
    "status": "processing",
    "progress": {
      "percentage": 60,
      "processedImages": 1,
      "totalImages": 2,
      "currentStep": "处理第2张图片",
      "estimatedTimeRemaining": "30 seconds"
    },
    "deviceId": "iPhone_12_Pro_A1B2C3D4E5F6"
  }
}
```

##### 3. 媒体文件验证接口

**视频验证请求示例：**
```http
POST /api/v1/media/validate
Content-Type: application/json
Authorization: Bearer {jwt_token}
X-Device-ID: {device_unique_id}

{
  "filename": "family_vacation.mp4",
  "fileSize": 157286400,
  "mimeType": "video/mp4",
  "mediaType": "video",
  "duration": 900,
  "deviceId": "iPhone_12_Pro_A1B2C3D4E5F6"
}
```

**图片验证请求示例：**
```http
POST /api/v1/media/validate
Content-Type: application/json
Authorization: Bearer {jwt_token}
X-Device-ID: {device_unique_id}

{
  "filename": "photo_album.jpg",
  "fileSize": 5242880,
  "mimeType": "image/jpeg",
  "mediaType": "image",
  "dimensions": {
    "width": 1920,
    "height": 1080
  },
  "deviceId": "iPhone_12_Pro_A1B2C3D4E5F6"
}
```

**批量图片验证请求示例：**
```http
POST /api/v1/media/validate/batch
Content-Type: application/json
Authorization: Bearer {jwt_token}
X-Device-ID: {device_unique_id}

{
  "mediaType": "image_batch",
  "images": [
    {
      "filename": "photo1.jpg",
      "fileSize": 5242880,
      "mimeType": "image/jpeg"
    },
    {
      "filename": "photo2.jpg",
      "fileSize": 4194304,
      "mimeType": "image/png"
    }
  ],
  "totalFileSize": 9437184,
  "deviceId": "iPhone_12_Pro_A1B2C3D4E5F6"
}
```

**视频验证成功返回示例：**
```json
{
  "success": true,
  "data": {
    "isValid": true,
    "mediaType": "video",
    "validationResults": {
      "duration": {
        "valid": true,
        "value": 900,
        "message": "视频时长符合要求"
      },
      "fileSize": {
        "valid": true,
        "value": 157286400,
        "message": "文件大小符合要求"
      },
      "format": {
        "valid": true,
        "value": "mp4",
        "message": "支持的视频格式"
      },
      "deviceId": {
        "valid": true,
        "value": "iPhone_12_Pro_A1B2C3D4E5F6",
        "message": "设备识别码有效"
      }
    }
  },
  "message": "视频验证通过"
}
```

**图片验证成功返回示例：**
```json
{
  "success": true,
  "data": {
    "isValid": true,
    "mediaType": "image",
    "validationResults": {
      "fileSize": {
        "valid": true,
        "value": 5242880,
        "message": "文件大小符合要求"
      },
      "format": {
        "valid": true,
        "value": "jpeg",
        "message": "支持的图片格式"
      },
      "dimensions": {
        "valid": true,
        "value": "1920x1080",
        "message": "图片尺寸符合要求"
      },
      "deviceId": {
        "valid": true,
        "value": "iPhone_12_Pro_A1B2C3D4E5F6",
        "message": "设备识别码有效"
      }
    }
  },
  "message": "图片验证通过"
}
```

**验证失败返回示例：**
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_FAILED",
    "message": "媒体文件验证失败",
    "details": {
      "mediaType": "video",
      "duration": {
        "valid": false,
        "value": 45,
        "message": "视频时长过短，最少需要5分钟"
      },
      "fileSize": {
        "valid": true,
        "value": 157286400,
        "message": "文件大小符合要求"
      },
      "format": {
        "valid": true,
        "value": "mp4",
        "message": "支持的视频格式"
      },
      "deviceId": {
        "valid": true,
        "value": "iPhone_12_Pro_A1B2C3D4E5F6",
        "message": "设备识别码有效"
      }
    }
  },
  "timestamp": "2025-01-24T10:30:00Z"
}
```

**图片验证失败返回示例：**
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_FAILED",
    "message": "图片验证失败",
    "details": {
      "mediaType": "image",
      "fileSize": {
        "valid": false,
        "value": 52428800,
        "message": "图片文件过大，最大支持10MB"
      },
      "format": {
        "valid": true,
        "value": "jpeg",
        "message": "支持的图片格式"
      },
      "dimensions": {
        "valid": false,
        "value": "800x600",
        "message": "图片分辨率过低，建议至少1080p"
      },
      "deviceId": {
        "valid": true,
        "value": "iPhone_12_Pro_A1B2C3D4E5F6",
        "message": "设备识别码有效"
      }
    }
  },
  "timestamp": "2025-01-24T10:30:00Z"
}
```

#### 错误码定义

| 错误码 | 描述 | HTTP状态码 |
|--------|------|------------|
| `INVALID_VIDEO_DURATION` | 视频时长不符合要求（5-30分钟） | 400 |
| `INVALID_FILE_SIZE` | 文件大小超出限制 | 400 |
| `UNSUPPORTED_FORMAT` | 不支持的媒体格式 | 400 |
| `INVALID_IMAGE_DIMENSIONS` | 图片尺寸不符合要求 | 400 |
| `INVALID_DEVICE_ID` | 设备识别码无效或缺失 | 400 |
| `DEVICE_NOT_AUTHORIZED` | 设备未授权访问 | 403 |
| `UPLOAD_FAILED` | 媒体文件上传失败 | 500 |
| `VALIDATION_FAILED` | 媒体文件验证失败 | 400 |
| `STORAGE_ERROR` | 存储服务错误 | 500 |
| `RATE_LIMIT_EXCEEDED` | 上传频率超限 | 429 |
| `BATCH_SIZE_EXCEEDED` | 批量上传数量超限 | 400 |
| `UNAUTHORIZED` | 未授权访问 | 401 |

#### 设备识别码规范

**设备ID格式：** `{设备型号}_{唯一标识符}`

**示例：**
- iPhone: `iPhone_12_Pro_A1B2C3D4E5F6`
- iPad: `iPad_Air_4_B2C3D4E5F6A1`
- Android: `Samsung_Galaxy_S21_C3D4E5F6A1B2`

**生成规则：**
1. 设备型号：去除空格，使用下划线连接
2. 唯一标识符：使用设备的IDFV（iOS）或Android ID的前12位
3. 总长度不超过50个字符
4. 只包含字母、数字和下划线

#### 客户端集成示例

**Swift代码示例：**
```swift
class MediaUploadService {
    private let deviceId: String
    
    init() {
        // 生成设备唯一识别码
        let deviceModel = UIDevice.current.model.replacingOccurrences(of: " ", with: "_")
        let deviceName = UIDevice.current.name.replacingOccurrences(of: " ", with: "_")
        let idfv = UIDevice.current.identifierForVendor?.uuidString.prefix(12) ?? "UNKNOWN"
        self.deviceId = "\(deviceModel)_\(deviceName)_\(idfv)"
    }
    
    // 视频上传
    func uploadVideo(videoURL: URL) async throws -> UploadResult {
        // 1. 先验证视频
        let validation = try await validateMedia(mediaURL: videoURL, mediaType: .video)
        guard validation.isValid else {
            throw UploadError.validationFailed(validation.errors)
        }
        
        // 2. 开始上传
        let uploadTask = createUploadTask(mediaURL: videoURL, mediaType: .video)
        return try await performUpload(task: uploadTask)
    }
    
    // 图片上传
    func uploadImage(imageURL: URL) async throws -> UploadResult {
        let validation = try await validateMedia(mediaURL: imageURL, mediaType: .image)
        guard validation.isValid else {
            throw UploadError.validationFailed(validation.errors)
        }
        
        let uploadTask = createUploadTask(mediaURL: imageURL, mediaType: .image)
        return try await performUpload(task: uploadTask)
    }
    
    // 批量图片上传
    func uploadImages(imageURLs: [URL]) async throws -> BatchUploadResult {
        let validation = try await validateBatchImages(imageURLs: imageURLs)
        guard validation.isValid else {
            throw UploadError.validationFailed(validation.errors)
        }
        
        let batchTask = createBatchUploadTask(imageURLs: imageURLs)
        return try await performBatchUpload(task: batchTask)
    }
    
    private func validateMedia(mediaURL: URL, mediaType: MediaType) async throws -> ValidationResult {
        let metadata = try extractMediaMetadata(from: mediaURL, type: mediaType)
        
        let request = ValidationRequest(
            filename: mediaURL.lastPathComponent,
            fileSize: metadata.fileSize,
            mimeType: metadata.mimeType,
            mediaType: mediaType,
            deviceId: self.deviceId,
            duration: mediaType == .video ? metadata.duration : nil,
            dimensions: mediaType == .image ? metadata.dimensions : nil
        )
        
        return try await apiClient.validateMedia(request)
    }
    
    private func createUploadTask(mediaURL: URL, mediaType: MediaType) -> UploadTask {
        return UploadTask(
            mediaURL: mediaURL,
            mediaType: mediaType,
            deviceId: self.deviceId,
            deviceInfo: DeviceInfo(
                model: UIDevice.current.model,
                osVersion: UIDevice.current.systemVersion,
                appVersion: Bundle.main.infoDictionary?["CFBundleShortVersionString"] as? String ?? "1.0.0"
            )
        )
    }
}

enum MediaType: String {
    case video = "video"
    case image = "image"
    case imageBatch = "image_batch"
}

struct DeviceInfo {
    let model: String
    let osVersion: String
    let appVersion: String
}
```