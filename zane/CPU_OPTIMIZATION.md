# OpenCV CPU环境优化说明

## 当前配置状态
✅ **已确认：你的代码完全在CPU环境下运行**

- 使用的是 `opencv-python-headless==4.8.1.78`（无头CPU版本）
- 没有使用任何GPU加速功能
- 所有图像处理操作都在CPU上执行
- 适配无头服务器环境（如Zeabur、Docker等）

## CPU性能优化

### 1. OpenCV CPU优化设置
代码中已添加以下优化：
```python
# 确保OpenCV使用CPU后端，优化CPU性能
cv2.setUseOptimized(True)  # 启用优化的CPU指令
cv2.setNumThreads(0)       # 使用所有可用CPU核心

# 无头环境配置 - 确保在服务器环境中正常运行
os.environ['OPENCV_IO_ENABLE_OPENEXR'] = '0'  # 禁用OpenEXR支持
os.environ['OPENCV_IO_ENABLE_JASPER'] = '0'   # 禁用Jasper支持
```

### 2. 并发处理优化
代码中的AI分析部分使用了异步并发处理：
- 默认最大并发数：10
- 可根据CPU核心数调整并发数
- 建议设置：`max_concurrent = min(10, os.cpu_count())`

### 3. 内存优化建议
```python
# 在处理大量帧时，及时释放内存
img = cv2.imread(frame_path)
# ... 处理图像 ...
del img  # 显式删除图像对象
```

## 系统要求

### 最低配置
- CPU: 双核处理器
- 内存: 4GB RAM
- 存储: 1GB可用空间

### 推荐配置
- CPU: 四核或更多核心处理器
- 内存: 8GB+ RAM
- 存储: 2GB+ 可用空间（用于临时帧存储）

## 性能预期

### 处理速度（基于CPU性能）
- **基础抽帧**: 10-50 帧/秒
- **AI分析**: 1-5 帧/秒（取决于网络和API响应）
- **关键帧筛选**: 即时处理

### 优化建议
1. **减少AI分析并发数**：如果CPU负载过高
2. **调整抽帧间隔**：减少基础帧数量
3. **使用SSD存储**：提高I/O性能

## 与GPU版本的区别

| 功能 | CPU版本 | GPU版本 |
|------|---------|---------|
| 基础抽帧 | ✅ 支持 | ✅ 支持（更快） |
| 图像读写 | ✅ 支持 | ✅ 支持（更快） |
| AI分析 | ✅ 支持 | ✅ 支持（相同） |
| 硬件要求 | 低 | 高（需要GPU） |
| 安装复杂度 | 简单 | 复杂 |

## 故障排除

### 如果遇到性能问题
1. 检查CPU使用率：`htop` 或任务管理器
2. 监控内存使用：确保有足够可用内存
3. 减少并发数：降低 `max_concurrent` 参数
4. 清理临时文件：定期清理frames目录

### 如果需要更高性能
考虑以下选项：
1. 升级到更强的CPU
2. 增加系统内存
3. 使用更快的存储设备
4. 优化抽帧参数（减少目标帧数）

## 总结
你的代码已经完全适配CPU环境，无需任何修改即可运行。添加的优化设置将进一步提升CPU性能。